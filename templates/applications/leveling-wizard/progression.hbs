<div class="leveling-wizard-progression-root">
  {{!-- Leveling Wizard Progression Template --}}
  {{!-- Displays the complete level progression grid with slots for item planning --}}

  <!-- Tab Navigation -->
  <div class="wizard-tabs">
    <nav class="tab-nav">
      <button class="tab-btn" data-tab="levelup"
              {{#if (eq activeTab 'levelup')}}aria-selected="true" class="active"{{/if}}>
        {{localize "DASU.Actor.levelingWizard.tabs.levelup"}}
      </button>
      <button class="tab-btn" data-tab="config"
              {{#if (eq activeTab 'config')}}aria-selected="true" class="active"{{/if}}>
        {{localize "DASU.Actor.levelingWizard.tabs.config"}}
      </button>
    </nav>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    {{#if (eq activeTab 'levelup')}}
      <div class="progression-content">

        <!-- Progression Header with Legend -->
        <div class="progression-header">
          <h3>{{localize "DASU.Actor.levelingWizard.progression.title"}}</h3>
          <div class="legend">
            <div class="legend-item">
              <span class="legend-color completed"></span>
              <span>{{localize "DASU.Actor.levelingWizard.progression.legend.completed"}}</span>
            </div>
            <div class="legend-item">
              <span class="legend-color current"></span>
              <span>{{localize "DASU.Actor.levelingWizard.progression.legend.current"}}</span>
            </div>
            <div class="legend-item">
              <span class="legend-color future"></span>
              <span>{{localize "DASU.Actor.levelingWizard.progression.legend.future"}}</span>
            </div>
          </div>
        </div>

        <!-- Levels Container -->
        <div class="levels-container">
          {{#each levels}}
            <div class="level-row {{#if isCurrentLevel}}current{{else if isCompleted}}completed{{else}}future{{/if}}"
                 data-level="{{level}}">

              <!-- Level Information and Bonuses -->
              <div class="level-info-combined">
                <div class="level-number">
                  <span class="level-label">{{localize "DASU.Actor.levelingWizard.progression.level"}} {{level}}</span>
                  {{#if isCurrentLevel}}
                    <i class="fas fa-crosshairs current-indicator"></i>
                  {{/if}}
                </div>

                <div class="level-requirements">
                  <div class="requirement">
                    <span class="requirement-label">{{localize "DASU.Actor.levelingWizard.progression.merit"}}</span>
                    <span class="requirement-value">{{meritRequired}}</span>
                  </div>
                  <div class="requirement">
                    <span class="requirement-label">{{localize "DASU.Actor.levelingWizard.progression.toLevel"}}</span>
                    <span class="requirement-value">{{toLevelRequired}}</span>
                  </div>
                </div>

                <div class="level-bonuses">
                  {{#each bonuses as |bonus|}}
                    <div class="bonus {{bonus.type}}-bonus" title="{{bonus.description}}">
                      <i class="{{bonus.icon}}"></i>
                      <span>{{bonus.text}}</span>
                    </div>
                  {{/each}}
                  {{#unless bonuses.length}}
                    <div class="no-bonus">
                      <span>{{localize "DASU.Actor.levelingWizard.progression.noBonuses"}}</span>
                    </div>
                  {{/unless}}
                </div>
              </div>

              <!-- Point Allocation Section -->
              <div class="level-points compact">
                <!-- Attribute Points (AP) Block -->
                {{#if apGained}}
                  <div class="point-block ap-block {{#if isCurrentLevel}}current{{else}}planned{{/if}}">
                    <div class="point-header">
                      <span class="point-label">
                        {{localize 'DASU.Actor.levelingWizard.progression.pointTypes.ap'}} {{#if pointAllocations.ap.spent}}{{pointAllocations.ap.spent}}/{{/if}}{{apGained}}
                      </span>
                      <button class="expand-toggle"
                              data-level="{{level}}"
                              data-action="toggleAttributeExpand"
                              title="{{localize 'DASU.Actor.levelingWizard.progression.showAllAttributes'}}">
                        <i class="fas fa-chevron-down"></i>
                      </button>
                    </div>

                    <!-- Collapsed view: Only allocated attributes -->
                    <div class="point-allocations attribute-allocations-collapsed">
                      {{#each pointAllocations.ap.attributes as |points attrName|}}
                        {{#if (gt points 0)}}
                          <div class="inline-allocation attribute-allocation compact">
                            <span class="attr-name">
                              {{#if (eq attrName "pow")}}{{localize "DASU.Actor.levelingWizard.progression.attributeAbbr.pow"}}
                              {{else if (eq attrName "dex")}}{{localize "DASU.Actor.levelingWizard.progression.attributeAbbr.dex"}}
                              {{else if (eq attrName "will")}}{{localize "DASU.Actor.levelingWizard.progression.attributeAbbr.will"}}
                              {{else if (eq attrName "sta")}}{{localize "DASU.Actor.levelingWizard.progression.attributeAbbr.sta"}}
                              {{else}}{{attrName}}{{/if}}
                            </span>
                            <span class="allocation-display">
                              {{getBaseAttributeTicks ../../actor attrName ../level}} → {{add (getBaseAttributeTicks ../../actor attrName ../level) points}}
                            </span>
                            <button class="remove-btn"
                                    data-level="{{../level}}"
                                    data-attribute="{{attrName}}"
                                    data-action="decreaseAttribute"
                                    title="{{localize 'DASU.Actor.levelingWizard.progression.removeAllocation'}}">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        {{/if}}
                      {{/each}}
                    </div>

                    <!-- Expanded view: All available attributes -->
                    <div class="point-allocations attribute-allocations-expanded" style="display: none;">
                      {{#each ../config.attributes as |attr key|}}
                        <div class="inline-allocation attribute-allocation">
                          <span class="attr-name">
                            {{#if (eq key "pow")}}{{localize "DASU.Actor.levelingWizard.progression.attributeAbbr.pow"}}
                            {{else if (eq key "dex")}}{{localize "DASU.Actor.levelingWizard.progression.attributeAbbr.dex"}}
                            {{else if (eq key "will")}}{{localize "DASU.Actor.levelingWizard.progression.attributeAbbr.will"}}
                            {{else if (eq key "sta")}}{{localize "DASU.Actor.levelingWizard.progression.attributeAbbr.sta"}}
                            {{else}}{{key}}{{/if}}
                          </span>
                          <div class="allocation-controls">
                            <button class="mini-btn decrease"
                                    data-level="{{../level}}"
                                    data-attribute="{{key}}"
                                    data-action="decreaseAttribute">{{localize 'DASU.Actor.levelingWizard.progression.buttons.decrease'}}</button>
                            <span class="point-value">{{getCurrentAllocation ../pointAllocations "ap" key}}</span>
                            <button class="mini-btn increase"
                                    data-level="{{../level}}"
                                    data-attribute="{{key}}"
                                    data-action="increaseAttribute">{{localize 'DASU.Actor.levelingWizard.progression.buttons.increase'}}</button>
                          </div>
                        </div>
                      {{/each}}
                    </div>
                  </div>
                {{/if}}

                <!-- Skill Points (SP) Block -->
                {{#if spGained}}
                  <div class="point-block sp-block {{#if isCurrentLevel}}current{{else}}planned{{/if}}">
                    <div class="point-header">
                      <span class="point-label">
                        {{localize 'DASU.Actor.levelingWizard.progression.pointTypes.sp'}} {{#if pointAllocations.sp.spent}}{{pointAllocations.sp.spent}}/{{/if}}{{spGained}}
                      </span>
                      <button class="expand-toggle"
                              data-level="{{level}}"
                              data-action="toggleSkillExpand"
                              title="{{localize 'DASU.Actor.levelingWizard.progression.showAllSkills'}}">
                        <i class="fas fa-chevron-down"></i>
                      </button>
                    </div>

                    <!-- Collapsed view: Only allocated skills -->
                    <div class="point-allocations skill-allocations-collapsed">
                      {{#each pointAllocations.sp.skills as |points skillName|}}
                        <div class="inline-allocation skill-allocation compact">
                          <span class="skill-name">{{skillName}}</span>
                          <span class="allocation-display">
                            {{getBaseSkillTicks ../../actor skillName ../level}} → {{add (getBaseSkillTicks ../../actor skillName ../level) points}}
                          </span>
                          <button class="remove-btn"
                                  data-level="{{../level}}"
                                  data-skill="{{skillName}}"
                                  data-action="decreaseSkill"
                                  title="{{localize 'DASU.Actor.levelingWizard.progression.removeAllocation'}}">
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                      {{/each}}
                      {{#unless pointAllocations.sp.skills}}
                        <div class="no-skills-allocated">
                          <span>{{localize "DASU.Actor.levelingWizard.progression.noSkillsAllocated"}}</span>
                          <button class="expand-btn"
                                  data-level="{{level}}"
                                  data-action="toggleSkillExpand">
                            <i class="fas fa-plus"></i> {{localize "DASU.Actor.levelingWizard.progression.addSkills"}}
                          </button>
                        </div>
                      {{/unless}}
                    </div>

                    <!-- Expanded view: All available skills -->
                    <div class="point-allocations skill-allocations-expanded" style="display: none;">
                      {{#each ../config.allSkills as |skill|}}
                        <div class="inline-allocation skill-allocation">
                          <span class="skill-name">{{skill.label}}</span>
                          <div class="allocation-controls">
                            <button class="mini-btn decrease"
                                    data-level="{{../level}}"
                                    data-skill="{{skill.value}}"
                                    data-action="decreaseSkill">{{localize 'DASU.Actor.levelingWizard.progression.buttons.decrease'}}</button>
                            <span class="point-value">{{getCurrentAllocation ../pointAllocations "sp" skill.value}}</span>
                            <button class="mini-btn increase"
                                    data-level="{{../level}}"
                                    data-skill="{{skill.value}}"
                                    data-action="increaseSkill">{{localize 'DASU.Actor.levelingWizard.progression.buttons.increase'}}</button>
                          </div>
                        </div>
                      {{/each}}
                    </div>
                  </div>
                {{/if}}
              </div>

              <!-- Item Slots Section -->
              <div class="level-slots">

                <!-- Ability Slot -->
                {{#if gainAbility}}
                  <div class="slot ability-slot {{#if assignedAbility}}has-item{{/if}}"
                       data-level="{{level}}"
                       data-slot-type="ability"
                       {{#if assignedAbility}}
                         data-item-uuid="{{assignedAbility.uuid}}"
                         data-item-name="{{assignedAbility.name}}"
                       {{/if}}>
                    <div class="slot-label">{{localize "DASU.Actor.levelingWizard.slots.ability"}}</div>
                    <div class="slot-content">
                      {{#if assignedAbility}}
                        <div class="slot-item" data-item-uuid="{{assignedAbility.uuid}}">
                          <span class="item-name">{{assignedAbility.name}}</span>
                          <button class="remove-item"
                                  data-action="removeItem"
                                  data-item-uuid="{{assignedAbility.uuid}}">{{localize 'DASU.Actor.levelingWizard.progression.buttons.remove'}}</button>
                        </div>
                      {{else}}
                        <i class="fas fa-plus"></i>
                      {{/if}}
                    </div>
                  </div>
                {{/if}}

                <!-- Schema Slot -->
                {{#if gainSchema}}
                  <div class="slot schema-slot {{#if assignedSchema}}has-item{{/if}} {{#if (eq schemaDetails.action "upgrade")}}upgrade-slot{{/if}}"
                       data-level="{{level}}"
                       data-slot-type="schema"
                       data-schema-type="{{schemaType}}"
                       {{#if assignedSchema}}
                         data-item-uuid="{{assignedSchema.uuid}}"
                         data-item-name="{{assignedSchema.name}}"
                       {{/if}}>
                    <div class="slot-label">
                      {{#if schemaDetails}}
                        {{#if (eq schemaDetails.action "upgrade")}}
                          {{#if schemaDetails.upgradeSlotNumber}}
                            {{#if schemaDetails.schemaId}}
                              {{localize 'DASU.Actor.levelingWizard.progression.upgradeSchemaWithId' schemaId=schemaDetails.schemaId number=schemaDetails.upgradeSlotNumber}}
                            {{else}}
                              {{localize 'DASU.Actor.levelingWizard.progression.upgradeSchemaSlot' number=schemaDetails.upgradeSlotNumber}}
                            {{/if}}
                          {{else}}
                            {{#if schemaDetails.schemaId}}
                              {{localize 'DASU.Actor.levelingWizard.progression.upgradeSchemaWithIdOnly' schemaId=schemaDetails.schemaId}}
                            {{else}}
                              {{localize 'DASU.Actor.levelingWizard.slots.upgradeSchema'}}
                            {{/if}}
                          {{/if}}
                        {{else}}
                          {{#if schemaDetails.slotNumber}}
                            {{#if schemaDetails.schemaId}}
                              {{localize 'DASU.Actor.levelingWizard.progression.newSchemaWithId' schemaId=schemaDetails.schemaId number=schemaDetails.slotNumber}}
                            {{else}}
                              {{localize 'DASU.Actor.levelingWizard.progression.newSchemaSlot' number=schemaDetails.slotNumber}}
                            {{/if}}
                          {{else}}
                            {{#if schemaDetails.schemaId}}
                              {{localize 'DASU.Actor.levelingWizard.progression.newSchemaWithIdOnly' schemaId=schemaDetails.schemaId}}
                            {{else}}
                              {{localize 'DASU.Actor.levelingWizard.slots.newSchema'}}
                            {{/if}}
                          {{/if}}
                        {{/if}}
                      {{else if (eq schemaType 'first')}}
                        {{localize 'DASU.Actor.levelingWizard.progression.firstSchemaLevel' level=(concat 'Lvl ' (if (eq level 1) '1' (if (eq level 5) '2' (if (eq level 15) '3' ''))))}}
                      {{else if (eq schemaType 'second')}}
                        {{localize 'DASU.Actor.levelingWizard.progression.secondSchemaLevel' level=(concat 'Lvl ' (if (eq level 10) '1' (if (eq level 20) '2' (if (eq level 25) '3' ''))))}}
                      {{else}}
                        {{localize 'DASU.Actor.levelingWizard.slots.schema'}}
                      {{/if}}
                    </div>
                    <div class="slot-content">
                      {{#if assignedSchema}}
                        <div class="slot-item schema-item-clickable {{#if (eq schemaDetails.action "upgrade")}}upgrade-item{{/if}}"
                             data-item-uuid="{{assignedSchema.uuid}}"
                             data-action="toggleDescription">
                          {{#if (eq schemaDetails.action "upgrade")}}
                            <div class="schema-upgrade-info">
                              <div class="schema-name">{{assignedSchema.name}}</div>
                              <div class="level-progression">
                                <span class="current-level">{{localize 'DASU.Actor.levelingWizard.progression.currentLevel'}} {{#if assignedSchema.system.level}}{{assignedSchema.system.level}}{{else}}1{{/if}}</span>
                                <i class="fas fa-arrow-right"></i>
                                <span class="next-level">{{localize 'DASU.Actor.levelingWizard.progression.nextLevel'}} {{add (or assignedSchema.system.level 1) 1}}</span>
                              </div>
                              <i class="fas fa-arrow-up upgrade-icon" title="{{localize 'DASU.Actor.levelingWizard.progression.schemaUpgradeTooltip'}}"></i>
                            </div>
                          {{else}}
                            <span class="item-name schema-name-clickable">{{assignedSchema.name}}</span>
                            <button class="remove-item"
                                    data-action="removeItem"
                                    data-item-uuid="{{assignedSchema.uuid}}"
                                    onclick="event.stopPropagation();">{{localize 'DASU.Actor.levelingWizard.progression.buttons.remove'}}</button>
                          {{/if}}
                        </div>
                      {{else}}
                        {{#if (eq schemaDetails.action "upgrade")}}
                          <div class="upgrade-placeholder">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>{{localize 'DASU.Actor.levelingWizard.progression.noSchemaInSlot' number=schemaDetails.upgradeSlotNumber}}</span>
                          </div>
                        {{else}}
                          <i class="fas fa-plus"></i>
                        {{/if}}
                      {{/if}}
                    </div>
                  </div>
                {{/if}}

                <!-- Feature Slot -->
                {{#if gainFeature}}
                  <div class="slot feature-slot {{#if assignedFeature}}has-item{{/if}}"
                       data-level="{{level}}"
                       data-slot-type="feature"
                       {{#if assignedFeature}}
                         data-item-uuid="{{assignedFeature.uuid}}"
                         data-item-name="{{assignedFeature.name}}"
                       {{/if}}>
                    <div class="slot-label">{{localize "DASU.Actor.levelingWizard.slots.feature"}}</div>
                    <div class="slot-content">
                      {{#if assignedFeature}}
                        <div class="slot-item" data-item-uuid="{{assignedFeature.uuid}}">
                          <span class="item-name">{{assignedFeature.name}}</span>
                          <button class="remove-item"
                                  data-action="removeItem"
                                  data-item-uuid="{{assignedFeature.uuid}}">{{localize 'DASU.Actor.levelingWizard.progression.buttons.remove'}}</button>
                        </div>
                      {{else}}
                        <i class="fas fa-plus"></i>
                      {{/if}}
                    </div>
                  </div>
                {{/if}}
              </div>
            </div>
          {{/each}}
        </div>
      </div>
    {{/if}}

    <!-- Config Tab Content -->
    {{#if (eq activeTab 'config')}}
      <div class="config-content">
        <h3>{{localize "DASU.Actor.levelingWizard.config.title"}}</h3>
        <p>{{localize "DASU.Actor.levelingWizard.config.placeholder"}}</p>
      </div>
    {{/if}}
  </div>
</div>