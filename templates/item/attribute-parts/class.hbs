{{! Class Attributes Template }}
<div class='tab flexcol {{tab.cssClass}}' data-group='primary' data-tab='attributes'>

  <div class="compact-form">
    <div class="form-row">
      <label>{{localize "DASU.Class.Version"}}</label>
      <input type="text" name="system.version" value="{{system.version}}" data-dtype="String" />
    </div>
    <div class="form-row">
      <label>{{localize "DASU.Class.CategoryLabel"}}</label>
      <select name="system.category" data-dtype="String">
        {{#each classCategories as |label value|}}
          <option value="{{@key}}" {{#if (eq ../system.category @key)}}selected{{/if}}>{{label}}</option>
        {{/each}}
      </select>
    </div>
    <fieldset>
      <legend>{{localize 'DASU.Description'}}</legend>
      {{formInput @root.htmlInputField value=system.description name="system.description" toggled=@root.editable enriched=enrichedDescription disabled=(not @root.editable)}}
    </fieldset>
  </div>

  <div class="compact-section">
    <h4>{{localize "DASU.Class.StartingAttributes"}} <small>({{system.startingAttributesTotal}}/4)</small></h4>
    <div class="compact-grid">
      {{#each attributeOptions as |label key|}}
        <div class="grid-item">
          <label>{{label}}</label>
          <input type="number" name="system.startingAttributes.{{@key}}" value="{{lookup ../system.startingAttributes @key}}" min="0" max="4" data-dtype="Number" />
        </div>
      {{/each}}
    </div>
  </div>

  <div class="compact-section">
    <h4>{{localize "DASU.Class.Progression"}}</h4>
    <div class="formula-row">
      <div class="form-row">
        <label>{{localize "DASU.Class.APFormula"}}</label>
        <input type="text" name="system.progression.apFormula" value="{{system.progression.apFormula}}" data-dtype="String" placeholder="{{localize 'DASU.Class.FormulaPlaceholders.ap'}}" />
      </div>
      <div class="form-row">
        <label>{{localize "DASU.Class.SPFormula"}}</label>
        <input type="text" name="system.progression.spFormula" value="{{system.progression.spFormula}}" data-dtype="String" placeholder="{{localize 'DASU.Class.FormulaPlaceholders.sp'}}" />
      </div>
    </div>

    {{#if system.progressionSamples}}
      <details class="progression-preview">
        <summary>{{localize "DASU.Class.ProgressionPreview"}}</summary>
        <table class="compact-table">
          <thead>
            <tr><th>Lvl</th><th>AP</th><th>SP</th></tr>
          </thead>
          <tbody>
            {{#each system.progressionSamples as |sample level|}}
              <tr><td>{{level}}</td><td>{{sample.ap}}</td><td>{{sample.sp}}</td></tr>
            {{/each}}
          </tbody>
        </table>
      </details>
    {{/if}}
  </div>

  <div class="compact-section">
    <h4>{{localize "DASU.Class.LevelSlots"}}</h4>
    <div class="level-slots-compact">
      <div class="level-slots-grid">
        {{#each (range 1 30) as |level|}}
          <div class="level-slot-item" data-level="{{level}}">
            <div class="level-header">
              <span class="level-number">{{localize "DASU.Level"}} {{level}}</span>
            </div>
            <div class="slot-types">
              {{#each (lookup ../system.levelSlots level) as |slot index|}}
                <div class="slot-type-tag {{#if slot.type}}enhanced-slot{{/if}}">
                  {{#if slot.type}}
                    {{! Enhanced schema slot structure }}
                    <span class="slot-type">{{localize (concat "DASU.Class.LevelBonus." slot.type)}}</span>
                    {{#if slot.schemaId}}
                      <span class="slot-detail">{{slot.schemaId}}</span>
                    {{/if}}
                    <select class="slot-action-select" data-level="{{add @../index 1}}" data-slot-index="{{index}}" data-field="action">
                      <option value="new" {{#if (eq slot.action "new")}}selected{{/if}}>{{localize 'DASU.Class.SlotActions.new'}}</option>
                      <option value="upgrade" {{#if (eq slot.action "upgrade")}}selected{{/if}}>{{localize 'DASU.Class.SlotActions.upgrade'}}</option>
                    </select>
                    {{#if (eq slot.action "new")}}
                      <input type="number"
                             class="slot-number-input"
                             data-level="{{add @../index 1}}"
                             data-slot-index="{{index}}"
                             data-field="slotNumber"
                             value="{{slot.slotNumber}}"
                             min="1"
                             max="10"
                             placeholder="{{localize 'DASU.Class.SlotActions.slotPlaceholder'}}" />
                    {{/if}}
                    {{#if (eq slot.action "upgrade")}}
                      <select class="slot-upgrade-target" data-level="{{add @../index 1}}" data-slot-index="{{index}}" data-field="upgradeSlotNumber">
                        <option value="">{{localize 'DASU.Class.SlotActions.selectSlotNumber'}}</option>
                        {{#each (getAvailableSlotNumbers @root.system.levelSlots slot.type (add @../index 1)) as |slotNumber|}}
                          <option value="{{slotNumber}}" {{#if (eq (toNumber slot.upgradeSlotNumber) (toNumber slotNumber))}}selected{{/if}}>
                            {{localize 'DASU.Class.SlotActions.slotNumber' number=slotNumber}}
                          </option>
                        {{/each}}
                      </select>
                    {{/if}}
                    <button type="button" class="remove-slot-type" data-level="{{add @../index 1}}" data-slot-type="{{slot.type}}" data-slot-index="{{index}}">
                      <i class="fas fa-times"></i>
                    </button>
                  {{else}}
                    {{! Simple slot structure }}
                    <span>{{localize (concat "DASU.Class.LevelBonus." slot)}}</span>
                    <button type="button" class="remove-slot-type" data-level="{{add @../index 1}}" data-slot-type="{{slot}}">
                      <i class="fas fa-times"></i>
                    </button>
                  {{/if}}
                </div>
              {{/each}}
              <select class="add-slot-type" data-level="{{level}}">
                <option value="">{{localize "DASU.Class.AddSlotType"}}</option>
                {{#each ../levelBonusTypes as |label value|}}
                  <option value="{{@key}}">{{label}}</option>
                {{/each}}
              </select>
            </div>
          </div>
        {{/each}}
      </div>
    </div>
  </section>
</div>